# 智能错题本系统架构设计

## 项目概述

**项目名称**：Smart Error Book（智能错题本）  
**技术栈**：FastAPI + Vue3 + PostgreSQL + Redis + AI (LLM)  
**包管理**：uv (后端) + pnpm (前端)  
**架构模式**：前后端分离 + 微服务预留 + DDD领域驱动设计

---

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户层 (User Layer)                      │
├─────────────────────────────────────────────────────────────────┤
│  Web App (Vue3)  │  Mobile App (Future)  │  Desktop (Future)    │
└────────────┬────────────────────────────────────────────────────┘
             │
             │ HTTPS/WebSocket
             │
┌────────────▼────────────────────────────────────────────────────┐
│                      API Gateway (Nginx/Caddy)                   │
├─────────────────────────────────────────────────────────────────┤
│  - 路由转发      - 负载均衡      - SSL终止      - 限流         │
└────────────┬────────────────────────────────────────────────────┘
             │
             │
┌────────────▼────────────────────────────────────────────────────┐
│                    应用层 (Application Layer)                    │
├─────────────────────────────────────────────────────────────────┤
│                      FastAPI Backend                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Auth Service │  │ Error Book   │  │ AI Analysis  │         │
│  │   Module     │  │   Module     │  │   Module     │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Knowledge    │  │ Practice     │  │ Report       │         │
│  │ Graph Module │  │   Module     │  │   Module     │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└────────────┬────────────────────────────────────────────────────┘
             │
             │
┌────────────▼────────────────────────────────────────────────────┐
│                    数据层 (Data Layer)                           │
├─────────────────────────────────────────────────────────────────┤
│  PostgreSQL         Redis Cache        MinIO/S3               │
│  (主数据库)          (缓存/会话)        (图片/文件存储)          │
│                                                                  │
│  Elasticsearch      RabbitMQ/Kafka    Neo4j (Future)          │
│  (全文搜索)          (消息队列)        (知识图谱)               │
└─────────────────────────────────────────────────────────────────┘
             │
             │
┌────────────▼────────────────────────────────────────────────────┐
│                   外部服务层 (External Services)                 │
├─────────────────────────────────────────────────────────────────┤
│  OpenAI/Claude API  │  OCR Service  │  SMS/Email Service       │
│  (AI分析)            │  (图片识别)   │  (通知服务)              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 核心功能模块

### 1. 用户认证模块 (Auth Module)
- 用户注册/登录（JWT）
- 权限管理（RBAC）
- 第三方登录（微信、QQ等）
- 会话管理

### 2. 错题管理模块 (Error Book Module)
- 错题录入（手动/拍照识别）
- 错题分类（学科、章节、难度）
- 错题编辑/删除
- 错题收藏/标签

### 3. AI 分析模块 (AI Analysis Module)
- 错误原因分析
- 知识点提取
- 相似题推荐
- 解题思路生成

### 4. 知识图谱模块 (Knowledge Graph Module)
- 知识点关联
- 薄弱点识别
- 学习路径规划
- 能力评估模型

### 5. 智能练习模块 (Practice Module)
- 个性化题目推荐
- 巩固练习生成
- 错题复习提醒
- 学习效果追踪

### 6. 学习报告模块 (Report Module)
- 学习数据统计
- 可视化报表
- 周报/月报生成
- 学习建议

---

## 技术选型理由

### 后端：FastAPI + uv
- **FastAPI**：高性能、自动API文档、类型检查、异步支持
- **uv**：极快的Python包管理器（比pip快10-100倍）
- **SQLAlchemy 2.0**：强大的ORM，支持异步
- **Pydantic V2**：数据验证和序列化
- **Alembic**：数据库迁移

### 前端：Vue3 + TypeScript
- **Vue3**：组合式API、性能优化、TypeScript支持
- **Vite**：极速开发体验
- **Pinia**：现代状态管理
- **Element Plus**：企业级UI组件库
- **Axios**：HTTP客户端
- **Echarts**：数据可视化

### 数据库
- **PostgreSQL**：可靠的关系型数据库，支持JSON
- **Redis**：缓存、会话存储、消息队列
- **MinIO**：对象存储（图片、文件）

### AI/ML
- **OpenAI API / Claude API**：错题分析、知识点提取
- **Sentence Transformers**：文本向量化（相似题匹配）
- **SpaCy/jieba**：中文NLP处理

---

## 数据库设计（核心表）

### 用户表 (users)
```sql
- id: UUID (PK)
- username: VARCHAR(50)
- email: VARCHAR(100)
- phone: VARCHAR(20)
- password_hash: VARCHAR(255)
- avatar_url: TEXT
- role: ENUM('student', 'teacher', 'admin')
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

### 错题表 (error_questions)
```sql
- id: UUID (PK)
- user_id: UUID (FK)
- subject: VARCHAR(50) (学科)
- chapter: VARCHAR(100) (章节)
- question_text: TEXT (题目内容)
- question_image_url: TEXT (题目图片)
- correct_answer: TEXT (正确答案)
- user_answer: TEXT (用户答案)
- difficulty: ENUM('easy', 'medium', 'hard')
- error_type: VARCHAR(50) (错误类型)
- created_at: TIMESTAMP
- review_count: INTEGER (复习次数)
- mastery_level: FLOAT (掌握程度 0-1)
```

### 知识点表 (knowledge_points)
```sql
- id: UUID (PK)
- name: VARCHAR(100)
- subject: VARCHAR(50)
- parent_id: UUID (FK, 自关联)
- description: TEXT
- created_at: TIMESTAMP
```

### 错题-知识点关联表 (question_knowledge_mapping)
```sql
- id: UUID (PK)
- question_id: UUID (FK)
- knowledge_point_id: UUID (FK)
- relevance_score: FLOAT (关联度)
```

### AI 分析记录表 (ai_analysis)
```sql
- id: UUID (PK)
- question_id: UUID (FK)
- analysis_type: VARCHAR(50)
- analysis_result: JSONB
- tokens_used: INTEGER
- created_at: TIMESTAMP
```

### 练习记录表 (practice_records)
```sql
- id: UUID (PK)
- user_id: UUID (FK)
- question_id: UUID (FK)
- is_correct: BOOLEAN
- time_spent: INTEGER (秒)
- created_at: TIMESTAMP
```

---

## API 设计（RESTful + GraphQL备选）

### 认证 API
```
POST   /api/v1/auth/register        # 用户注册
POST   /api/v1/auth/login           # 用户登录
POST   /api/v1/auth/refresh         # 刷新token
POST   /api/v1/auth/logout          # 登出
GET    /api/v1/auth/me              # 获取当前用户信息
```

### 错题 API
```
POST   /api/v1/errors               # 创建错题
GET    /api/v1/errors               # 获取错题列表（分页、筛选）
GET    /api/v1/errors/{id}          # 获取错题详情
PUT    /api/v1/errors/{id}          # 更新错题
DELETE /api/v1/errors/{id}          # 删除错题
POST   /api/v1/errors/batch         # 批量导入错题
POST   /api/v1/errors/ocr           # OCR识别错题
```

### AI 分析 API
```
POST   /api/v1/ai/analyze           # 分析错题
POST   /api/v1/ai/similar           # 查找相似题
POST   /api/v1/ai/explain           # 生成解题思路
POST   /api/v1/ai/extract-knowledge # 提取知识点
```

### 知识图谱 API
```
GET    /api/v1/knowledge/graph      # 获取知识图谱
GET    /api/v1/knowledge/weak-points # 获取薄弱知识点
GET    /api/v1/knowledge/learning-path # 获取学习路径
```

### 练习 API
```
GET    /api/v1/practice/recommend   # 推荐练习题
POST   /api/v1/practice/submit      # 提交练习答案
GET    /api/v1/practice/review-plan # 获取复习计划
```

### 报告 API
```
GET    /api/v1/reports/daily        # 获取日报
GET    /api/v1/reports/weekly       # 获取周报
GET    /api/v1/reports/statistics   # 获取统计数据
GET    /api/v1/reports/export       # 导出报告
```

---

## 项目目录结构

```
smart-error-book/
├── backend/                    # 后端项目
│   ├── pyproject.toml         # uv 配置文件
│   ├── uv.lock                # 依赖锁文件
│   ├── .env.example           # 环境变量示例
│   ├── alembic.ini            # 数据库迁移配置
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py            # FastAPI 应用入口
│   │   ├── config.py          # 配置管理
│   │   ├── dependencies.py    # 依赖注入
│   │   ├── api/               # API路由层
│   │   │   ├── __init__.py
│   │   │   ├── v1/
│   │   │   │   ├── __init__.py
│   │   │   │   ├── auth.py
│   │   │   │   ├── errors.py
│   │   │   │   ├── ai.py
│   │   │   │   ├── knowledge.py
│   │   │   │   ├── practice.py
│   │   │   │   └── reports.py
│   │   ├── core/              # 核心功能
│   │   │   ├── __init__.py
│   │   │   ├── security.py    # 安全相关（JWT、密码）
│   │   │   ├── database.py    # 数据库连接
│   │   │   ├── cache.py       # Redis缓存
│   │   │   └── exceptions.py  # 自定义异常
│   │   ├── models/            # SQLAlchemy 模型（数据库表）
│   │   │   ├── __init__.py
│   │   │   ├── user.py
│   │   │   ├── error_question.py
│   │   │   ├── knowledge_point.py
│   │   │   └── practice_record.py
│   │   ├── schemas/           # Pydantic 模型（API输入输出）
│   │   │   ├── __init__.py
│   │   │   ├── user.py
│   │   │   ├── error_question.py
│   │   │   ├── ai.py
│   │   │   └── common.py
│   │   ├── services/          # 业务逻辑层
│   │   │   ├── __init__.py
│   │   │   ├── user_service.py
│   │   │   ├── error_service.py
│   │   │   ├── ai_service.py
│   │   │   ├── knowledge_service.py
│   │   │   └── practice_service.py
│   │   ├── repositories/      # 数据访问层（Repository模式）
│   │   │   ├── __init__.py
│   │   │   ├── base.py
│   │   │   ├── user_repo.py
│   │   │   └── error_repo.py
│   │   ├── tasks/             # 异步任务（Celery/ARQ）
│   │   │   ├── __init__.py
│   │   │   ├── ai_tasks.py
│   │   │   └── notification_tasks.py
│   │   ├── utils/             # 工具函数
│   │   │   ├── __init__.py
│   │   │   ├── ocr.py
│   │   │   ├── file_upload.py
│   │   │   └── ai_client.py
│   │   └── tests/             # 测试
│   │       ├── __init__.py
│   │       ├── conftest.py
│   │       ├── test_auth.py
│   │       └── test_errors.py
│   └── alembic/               # 数据库迁移文件
│       └── versions/
│
├── frontend/                   # 前端项目
│   ├── package.json
│   ├── pnpm-lock.yaml
│   ├── vite.config.ts
│   ├── tsconfig.json
│   ├── index.html
│   ├── .env.development
│   ├── .env.production
│   ├── src/
│   │   ├── main.ts            # 入口文件
│   │   ├── App.vue
│   │   ├── api/               # API 请求封装
│   │   │   ├── index.ts
│   │   │   ├── auth.ts
│   │   │   ├── error.ts
│   │   │   └── ai.ts
│   │   ├── assets/            # 静态资源
│   │   ├── components/        # 公共组件
│   │   │   ├── common/        # 通用组件
│   │   │   │   ├── Layout.vue
│   │   │   │   └── PageHeader.vue
│   │   │   ├── ErrorQuestion/ # 错题相关组件
│   │   │   │   ├── ErrorCard.vue
│   │   │   │   ├── ErrorForm.vue
│   │   │   │   └── ErrorDetail.vue
│   │   │   └── Charts/        # 图表组件
│   │   │       └── StatisticsChart.vue
│   │   ├── composables/       # 组合式函数
│   │   │   ├── useAuth.ts
│   │   │   ├── useError.ts
│   │   │   └── useAI.ts
│   │   ├── layouts/           # 布局组件
│   │   │   ├── DefaultLayout.vue
│   │   │   └── AuthLayout.vue
│   │   ├── router/            # 路由配置
│   │   │   └── index.ts
│   │   ├── stores/            # Pinia 状态管理
│   │   │   ├── user.ts
│   │   │   ├── error.ts
│   │   │   └── app.ts
│   │   ├── types/             # TypeScript 类型定义
│   │   │   ├── api.ts
│   │   │   ├── error.ts
│   │   │   └── user.ts
│   │   ├── utils/             # 工具函数
│   │   │   ├── request.ts     # Axios封装
│   │   │   ├── storage.ts
│   │   │   └── helpers.ts
│   │   └── views/             # 页面组件
│   │       ├── auth/
│   │       │   ├── Login.vue
│   │       │   └── Register.vue
│   │       ├── dashboard/
│   │       │   └── Dashboard.vue
│   │       ├── errors/
│   │       │   ├── ErrorList.vue
│   │       │   ├── ErrorDetail.vue
│   │       │   └── AddError.vue
│   │       ├── practice/
│   │       │   ├── PracticeList.vue
│   │       │   └── PracticeSession.vue
│   │       ├── knowledge/
│   │       │   └── KnowledgeGraph.vue
│   │       └── reports/
│   │           └── ReportView.vue
│
├── docker/                     # Docker 配置
│   ├── backend.Dockerfile
│   ├── frontend.Dockerfile
│   └── nginx.conf
│
├── docker-compose.yml          # Docker Compose 配置
├── docker-compose.dev.yml      # 开发环境配置
├── .gitignore
└── README.md                   # 项目说明文档
```

---

## 开发工作流

### 1. 本地开发
```bash
# 后端
cd backend
uv sync                         # 安装依赖
uv run alembic upgrade head     # 数据库迁移
uv run uvicorn app.main:app --reload  # 启动开发服务器

# 前端
cd frontend
pnpm install                    # 安装依赖
pnpm dev                        # 启动开发服务器
```

### 2. Docker 开发
```bash
docker-compose -f docker-compose.dev.yml up
```

### 3. 生产部署
```bash
docker-compose up -d
```

---

## 扩展性设计

### 1. 模块化设计
- 每个功能模块独立
- 清晰的依赖关系
- 易于添加新功能

### 2. 微服务预留
- API 版本化（v1, v2...）
- 服务间通信接口（gRPC/REST）
- 消息队列解耦

### 3. 数据库分片
- 用户分片（user_id hash）
- 读写分离
- 缓存策略

### 4. AI 模型可替换
- 统一的 AI Service 接口
- 支持多种 LLM 切换
- 本地模型部署选项

### 5. 多租户支持
- 数据隔离
- 资源配额
- 定制化配置

---

## 性能优化策略

### 1. 缓存策略
- Redis 缓存热点数据
- CDN 加速静态资源
- HTTP 缓存头设置

### 2. 数据库优化
- 索引优化
- 查询优化
- 连接池管理

### 3. 前端优化
- 路由懒加载
- 组件按需加载
- 图片懒加载
- Bundle 分包

### 4. API 优化
- GraphQL（减少请求次数）
- WebSocket（实时通信）
- 批量操作接口

---

## 安全策略

### 1. 认证授权
- JWT Token（短期 + 长期）
- RBAC 权限控制
- API Rate Limiting

### 2. 数据安全
- 密码加密（bcrypt）
- SQL 注入防护（ORM）
- XSS 防护
- CSRF 防护

### 3. API 安全
- HTTPS 强制
- CORS 配置
- API 签名验证

---

## 监控与日志

### 1. 日志系统
- 结构化日志（JSON）
- 日志分级
- 日志聚合（ELK Stack）

### 2. 监控指标
- API 响应时间
- 错误率
- 数据库性能
- 缓存命中率

### 3. 告警系统
- 异常告警
- 性能告警
- 业务指标告警

---

## MVP 开发计划

### Phase 1（2周）：基础框架
- ✅ 项目初始化
- ✅ 数据库设计
- ✅ 用户认证系统
- ✅ 基础UI框架

### Phase 2（2周）：核心功能
- ✅ 错题录入
- ✅ 错题列表/详情
- ✅ AI 分析基础功能
- ✅ 简单统计

### Phase 3（2周）：智能化
- ✅ 知识点提取
- ✅ 相似题推荐
- ✅ 个性化练习
- ✅ 学习报告

### Phase 4（1周）：优化上线
- ✅ 性能优化
- ✅ 测试完善
- ✅ 部署上线
- ✅ 用户反馈收集

---

## 成本估算（MVP阶段）

### 服务器成本
- 云服务器：¥100-300/月（2核4G）
- 数据库：¥100-200/月
- 对象存储：¥50/月
- CDN：¥50/月
**小计**：¥300-600/月

### AI API 成本
- OpenAI API：¥500-2000/月（取决于用量）
- OCR 服务：¥200-500/月

### 总计（月成本）
**¥1000-3000/月**

---

## 后续扩展方向

1. **移动端 APP**（Flutter/React Native）
2. **教师端功能**（班级管理、作业批改）
3. **社区功能**（错题分享、讨论）
4. **付费功能**（高级AI分析、无限存储）
5. **企业版**（学校/机构版本）
6. **多学科扩展**（目前聚焦数学/理科）
7. **AI 私有化部署**（本地 LLM）

---

## 总结

这是一个完整、可扩展、专业的系统架构设计。通过模块化、分层设计，确保系统在 MVP 阶段能够快速验证，同时为未来的功能扩展和性能优化预留了充足空间。

